from snakemake.remote.HTTP import RemoteProvider as HTTPRemoteProvider
import requests
import xml.etree.ElementTree as ET
import os

HTTP = HTTPRemoteProvider()
YEARS=[*range(1998, 2021)]


def download_file(input, output):
    root = ET.parse(input)

    urls = root.findall("./dataset/dataTable/physical/distribution/online/url")
    filenames = root.findall("./dataset/dataTable/entityName")

    file_pairs = {filenames[i].text[:4]: urls[i].text for i in range(len(urls))}

    yr = output[5:9]

    resp = requests.get(file_pairs[yr])
    open(output, "wb").write(resp.content)


rule all:
    input:
        "plots/temperature.png"


rule metadata:
    input: HTTP.remote("https://arcticdata.io/metacat/d1/mn/v2/object/urn%3Auuid%3A0b0a5a34-a950-4685-a6d1-76714116ac82", keep_local = True)
    output: "metadata.xml"
    run:
        outputName = "metadata.xml"
        shell("mv {input} {outputName}")


rule download:
    input: "metadata.xml"
    output: path=expand("data/{year}.csv", year=YEARS)
    run:
        for p in output.path:
             download_file(input[0], p)


rule summarize:
    input:
       expand("data/{year}.csv", year=YEARS)
    output:
        "data_combined/full_climate.csv"
    script:
        "scripts/summarize.py"


rule plot:
    input:
       "data_combined/full_climate.csv"
    output:
        "plots/temperature.png"
    script:
        "scripts/plot.py"